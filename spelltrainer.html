<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>SpellTrainer v0.61</title>
<meta http-equiv="Content-Type" content="Text/HTML; CharSet=ISO-8859-1">
<meta name="Author" content="Vasily Zakharov (vmzakhar@gmail.com)">
<link rel="Shortcut Icon" href="favicon.ico">
<style type="text/css">
html, body {
	margin: 0;
	padding: 0;
	font-family: Verdana, Arial, Helvetica, sans-serif;
}

p, td {
	font-size: 13px;
	line-height: 1.4;
	margin: 2ex 0;
	padding: 0;
}

.bold {
	font-weight: bold;
}

.light {
	font-weight: normal;
}

.right {
	text-align: right;
}

.welcome {
	color: black;
	background-color: white;
}

.ready {
	color: white;
	background-color: black;
}

.attack {
	color: green;
	background-color: black;
}

.defence {
	color: white;
	background-color: maroon;
}

.flash {
	color: white;
	background-color: white;
}

.example {
	font-weight: bold;
	padding: 3px;
}

table.visible {
	display: table;
}

td.visible {
	display: table-cell;
}

.invisible {
	display: none;
}

td.menu {
	vertical-align: middle;
	white-space: nowrap;
	font-size: 70%;
	font-weight: bold;
	color: black;
	padding: 0 0.1em 0 0.5em;
}

button.menu {
	width: 5em;
	height: 42px;
}

.input {
	border: 1px inset gray;
}

span.input {
	padding: 1px;
}

input.input {
	width: 4em;
}

input.menu {
	font-size: 100%;
	padding: 1px;
}

input.checkbox {
	border: 0;
	margin: 0;
}

img.logo {
	background-color: white;
	border: 1px solid black;
}

img.valid {
	width: 88px;
	height: 31px;
	border: 0;
}

#headerBlock, #footerBlock {
	color: black;
	background-color: gray;
	height: 42px;
}

#headerTable {
	width: 100%;
	border: 1px solid black;
}

#logoBlock {
	padding-left: 4px;
}

#headerTitle {
	text-align: center;
	color: black;
	font-weight: bold;
	padding: 0 0.2em 0 0.6em;
}

#menuPadding {
	width: 100%;
}

#noscriptTitle, #welcomeTitle {
	margin: 0;
	padding: 0;
	white-space: nowrap;
}

#loadingBlock, #mainBlock {
	width: 100%;
	height: 100%;
}

#infoBlock, #welcomeBlock {
	color: black;
	text-align: center;
	white-space: nowrap;
}

#speedBlock {
	width: 200px;
	height: 30px;
	overflow: scroll;
}

#speedFill {
	width: 1000px;
	height: 0;
}

#speedControlID {
	width: 2em;
}

#fontFamilyControlID {
	width: 5em;
}

#castBlock {
	text-align: center;
	vertical-align: middle;
	font-weight: bold;
}

#bigStartButton {
	font-size: 300%;
	font-weight: bold;
	cursor: pointer;
	margin: 0.5ex 0;
	padding: 0.5ex 0.5em;
}

#loggerBlock {
	height: 38px;
	font-size: 50%;
	overflow: auto;
}
</style>
<!--[if IE]>
<style type="text/css">
table.visible, td.visible {
	display: block;
}

input.checkbox {
	margin-left: -3px;
}

span.input {
	padding-top: 2px;
}

#speedBlock {
	overflow-x: scroll;
	overflow-y: hidden;
}

#bigStartButton {
	margin: 1.5ex 0;
	padding: 0.1ex 0;
}
</style>
<![endif]-->
<script type="text/javascript">
var DEFAULT_FONT_NAME = 'Verdana,Arial,Helvetica,sans-serif';
var MIN_FONT_SIZE = 20;
var RULE_OF_N_SPELLS = 3;

function debug(message) {
    logger.innerHTML += new Date().toLocaleTimeString() + '&nbsp;&nbsp;' + message + '<br>';
    logger.scrollTop = logger.scrollHeight;
}

function SpellGenerator() {
    this.spells = [];
    this.previousSpells = [];
    this.next = function() {
        newSpell:
        while (true) {
            spell = this.spells[Math.floor(Math.random() * this.spells.length)];
            baseIndex = spell.indexOf(' ');
            baseSpell = baseIndex >= 0 ? spell.slice(0, baseIndex) : spell;
            if (this.spells.length >= RULE_OF_N_SPELLS) {
                for (var i = 0, previousSpell; previousSpell = this.previousSpells[i]; i++) {
                    if (previousSpell === baseSpell) {
                        continue newSpell;
                    }
                }
            }
            this.previousSpells = this.previousSpells.concat([baseSpell]).slice(-RULE_OF_N_SPELLS + 1);
            return spell;
        }
    }
}

function setSpells(element) {
    if (!simplaSpellControl.checked && !maximaSpellControl.checked && !ultimaSpellControl.checked) {
        (element || simplaSpellControl).checked = true;
    }
    if (cast.className != 'visible') {
        return;
    }
    debug('setSpells');
    attackSpells.spells = defenceSpells.spells =
        (simplaSpellControl.checked ? vipSpellControl.checked ? simpla.concat(simplaVip) : simpla : []).concat(
        (maximaSpellControl.checked ? vipSpellControl.checked ? maxima.concat(maximaVip) : maxima : []),
        (ultimaSpellControl.checked ? vipSpellControl.checked ? ultima.concat(ultimaVip) : ultima : []));
    setFontNeeded = true;
}

function castSpell() {
    if (attackControl.checked && (!defenceControl.checked || Math.random() >= 0.5)) {
        cast.innerHTML = attackSpells.next();
        body.className = 'attack';
        debug('Attack: ' + cast.innerHTML);
    } else {
        cast.innerHTML = defenceSpells.next();
        body.className = 'defence';
        debug('Defence: ' + cast.innerHTML);
    }
    timeout = setTimeout('hideSpell()', spellDelay);
}

function hideSpell() {
    body.className = 'flash';
    timeout = setTimeout('castSpell()', 100);
    if (setFontNeeded) {
        setFont();
    }
}

function setSpeed() {
    debug('setSpeed');
    speedScroll.scrollLeft = (speedScroll.scrollWidth - speedScroll.offsetWidth) * (speedControl.value - 1) / 9;
}

function adjustSpeed() {
    debug('adjustSpeed');
    speedControl.value = 1 + Math.round(speedScroll.scrollLeft * 9 / (speedScroll.scrollWidth - speedScroll.offsetWidth));
    spellDelay = 10000 / speedControl.value;
}

function setColors() {
    debug('setColors');
    function doSetColors(selector, field, display, control, defaultValue) {
        function getStyle(selector) {
            var rules = document.styleSheets[0].cssRules;
            if (!rules) {
                rules = document.styleSheets[0].rules;
            }
            for (var i = 0; rule = rules[i]; i++) {
                if (rule.selectorText === selector) {
                    return rule.style;
                }
            }
        }
        try {
            getStyle(selector)[field] = display.style.backgroundColor = control.value;
        } catch(err) {
            getStyle(selector)[field] = display.style.backgroundColor = defaultValue;
        }
    }
    doSetColors('.attack', 'color', attackForegroundDisplay, attackForegroundControl, 'gray');
    doSetColors('.attack', 'backgroundColor', attackBackgroundDisplay, attackBackgroundControl, 'white');
    doSetColors('.defence', 'color', defenceForegroundDisplay, defenceForegroundControl, 'gray');
    doSetColors('.defence', 'backgroundColor', defenceBackgroundDisplay, defenceBackgroundControl, 'black');
}

function resize() {
    debug('resize');
    cast.style.fontSize = MIN_FONT_SIZE;
    cast.style.fontSize = Math.floor(Math.min(cast.offsetHeight * 0.7, cast.offsetWidth * aspect)) + 'px';
}

function setFont() {
    if (cast.className != 'visible') {
        return;
    }
    debug('setFont');
    setFontNeeded = false;
    var savedClass = body.className;
    var savedContent = cast.innerHTML;
    var spells = attackSpells.spells.concat(defenceSpells.spells);
    body.className = 'flash';
    cast.style.fontFamily = fontFamilyControl.value + ',' + DEFAULT_FONT_NAME;
    cast.style.fontWeight = fontWeightControl.checked ? 'bold' : 'normal';
    cast.style.fontStyle = fontStyleControl.checked ? 'italic' : 'normal';
    cast.style.fontSize = MIN_FONT_SIZE;
    cast.innerHTML = '<span id="test"><\/span>';
    var test = document.getElementById('test');
    aspect = 1000;
    for (var i = 0; test.innerHTML = spells[i]; i++) {
        aspect = Math.min(aspect, test.offsetHeight / test.offsetWidth);
    }
    aspect *= 0.7;
    resize();
    cast.innerHTML = savedContent;
    body.className = savedClass;
}

function start() {
    debug('start');
    startButton.innerHTML = 'Stop';
    startButton.onclick = stop;
    body.className = 'flash';
    welcome.className = 'invisible';
    cast.className = 'visible';
    setSpells();
    setFont();
    cast.innerHTML = 'Get ready!';
    body.onresize = onresize = resize;
    body.className = 'ready';
    timeout = setTimeout('hideSpell()', spellDelay);
}

function stop() {
    debug('stop');
    clearTimeout(timeout);
    startButton.innerHTML = 'Start';
    startButton.onclick = start;
    body.className = 'flash';
    cast.className = 'invisible';
    welcome.className = 'visible';
    body.className = 'welcome';
    body.onresize = onresize = null;
}

function reset() {
    debug('reset');
    simplaSpellControl.checked = true;
    maximaSpellControl.checked = true;
    ultimaSpellControl.checked = false;
    vipSpellControl.checked = true;
    speedControl.value = 3;
    setSpeed();
    attackControl.checked = true;
    attackForegroundControl.value = 'green';
    attackBackgroundControl.value = 'black';
    defenceControl.checked = true;
    defenceForegroundControl.value = 'white';
    defenceBackgroundControl.value = 'maroon';
    setColors();
    fontFamilyControl.value = DEFAULT_FONT_NAME.slice(0, DEFAULT_FONT_NAME.indexOf(','));
    fontWeightControl.checked = true;
    fontStyleControl.checked = false;
    setSpells();
}

function main() {
    logger = document.getElementById('loggerBlock');
    debug('main');
    // Create basic spell lists
    simpla = ['Impedimenta', 'Tarantallegra', 'Silencio',	// Protego
              'Rictusempra', 'Incarcero', 'Mento Menores',	// Defendo
              'Stupefy', 'Achelitus', 'Maledicero'];		// Enervate
    simplaVip = ['Incendio', 'Deluvium', 'Tormencio', 'Conjunctivitus'];
    function arrayWithSuffix(array, suffix) {
        ret = [];
        for (var i = 0, s; s = array[i]; i++) {
             ret.push(s + ' ' + suffix);
        };
        return ret;
    }
    maxima = arrayWithSuffix(simpla, 'Maxima').concat('Petrificus Totalus');
    maximaVip = arrayWithSuffix(simplaVip, 'Maxima').concat('Expelliarmus');
    ultima = arrayWithSuffix(simpla, 'Ultima');
    ultimaVip = arrayWithSuffix(simplaVip, 'Ultima');
    attackSpells = new SpellGenerator();
    defenceSpells = new SpellGenerator();
    // Show main page
    document.getElementById('loadingBlock').className = 'invisible';
    document.getElementById('mainBlock').className = 'visible';
    // Basic blocks
    body = document.getElementsByTagName('body')[0];
    cast = document.getElementById('castBlock');
    welcome = document.getElementById('welcomeBlock');
    startButton = document.getElementById('startButtonID');
    resetButton = document.getElementById('resetButtonID');
    // Spell controls
    simplaSpellControl = document.getElementById('simplaSpellControlID');
    maximaSpellControl = document.getElementById('maximaSpellControlID');
    ultimaSpellControl = document.getElementById('ultimaSpellControlID');
    vipSpellControl = document.getElementById('vipSpellControlID');
    // Speed controls
    speedControl = document.getElementById('speedControlID');
    speedScroll = document.getElementById('speedBlock');
    speedScroll.style.height = speedScroll.offsetHeight - speedScroll.clientHeight + 'px';
    speedScroll.onscroll = adjustSpeed;
    // Attack controls
    attackControl = document.getElementById('attackControlID');
    attackForegroundControl = document.getElementById('attackForegroundControlID');
    attackForegroundDisplay = document.getElementById('attackForegroundDisplayID');
    attackBackgroundControl = document.getElementById('attackBackgroundControlID');
    attackBackgroundDisplay = document.getElementById('attackBackgroundDisplayID');
    // Defence controls
    defenceControl = document.getElementById('defenceControlID');
    defenceForegroundControl = document.getElementById('defenceForegroundControlID');
    defenceForegroundDisplay = document.getElementById('defenceForegroundDisplayID');
    defenceBackgroundControl = document.getElementById('defenceBackgroundControlID');
    defenceBackgroundDisplay = document.getElementById('defenceBackgroundDisplayID');
    // Font controls
    fontFamilyControl = document.getElementById('fontFamilyControlID');
    fontWeightControl = document.getElementById('fontWeightControlID');
    fontStyleControl = document.getElementById('fontStyleControlID');
    // Load initial configuration
    reset();
    body.className = 'welcome';
}
</script>
</head>
<body onload="main()">
  <table id="loadingBlock" class="visible" cellspacing="0" cellpadding="0">
    <tr>
      <td id="infoBlock">
        <h1 id="noscriptTitle">SpellTrainer v0.61</h1>
        <p>[<a href="http://jolaf.jnm.ru/spelltrainer/">Latest version</a>] [<a href="http://code.google.com/p/spelltrainer/">Project page</a>] [<a href="mailto:vmzakhar@gmail.com?Subject=SpellTrainer">Contact mail</a>]</p>
        <p><img class="logo" src="wand.png" alt=""></p>
        <p>This software is created to train players in spellcasting for <a href="http://hp-ekb.ru">Hogwarts Seasons LARPs</a>.</p>
        <br>
        <script type="text/javascript">document.write('<p class="bold">...loading, please wait...<\/p>')</script>
        <noscript>
          <p class="bold">This page requires <a href="http://mozilla.org/js/">JavaScript</a> to operate.</p>
          <p class="bold">Please enable JavaScript in your browser and reload the page.</p>
        </noscript>
        <br>
        <p>If you experience problems or want to report a bug &ndash; please mail to <a href="mailto:vmzakhar@gmail.com?Subject=SpellTrainer">vmzakhar@gmail.com</a>.</p>
      </td>
    </tr>
  </table>
  <table id="mainBlock" class="invisible" cellspacing="0" cellpadding="0">
    <tr>
      <td id="headerBlock">
        <table id="headerTable" cellspacing="0" cellpadding="0">
          <tr>
            <td id="logoBlock"><img class="logo" src="wand.png" alt=""></td>
            <td id="headerTitle">SpellTrainer<br>v0.61</td>
            <td id="menuPadding"></td>
            <td>
              <table align="right" cellspacing="0" cellpadding="0">
                <tr>
                  <td>
                    <table cellspacing="0" cellpadding="0">
                      <tr>
                        <td rowspan="2" class="menu"><button id="startButtonID" class="menu" type="button" onclick="start()">Start</button></td>
                        <td class="menu right">Simpla <input id="simplaSpellControlID" class="checkbox" type="checkbox" onclick="setSpells(this)"></td>
                        <td class="menu right">Ultima <input id="ultimaSpellControlID" class="checkbox" type="checkbox" onclick="setSpells(this)"></td>
                        <td class="menu">Tempo <input id="speedControlID" class="menu input" type="text" maxlength="2" onchange="setSpeed()"> <span class="light">1 slowest, 10 fastest</span></td>
                        <td class="menu right">Attack <input id="attackControlID" class="checkbox" type="checkbox"> <input id="attackForegroundControlID" class="menu input" type="text" maxlength="20" onchange="setColors()"><span id="attackForegroundDisplayID" class="input">&nbsp;&nbsp;&nbsp;</span> on <span id="attackBackgroundDisplayID" class="input">&nbsp;&nbsp;&nbsp;</span><input id="attackBackgroundControlID" class="menu input" type="text" maxlength="20" onchange="setColors()"></td>
                        <td class="menu">Font <input id="fontFamilyControlID" class="menu input" type="text" maxlength="32" onchange="setFont()"></td>
                        <td rowspan="2" class="menu"><button id="resetButtonID" class="menu" type="button" onclick="reset()">Reset</button></td>
                      </tr>
                      <tr>
                        <td class="menu right">Maxima <input id="maximaSpellControlID" class="checkbox" type="checkbox" onclick="setSpells(this)"></td>
                        <td class="menu right">VIP <input id="vipSpellControlID" class="checkbox" type="checkbox" onclick="setSpells(this)"></td>
                        <td class="menu"><div id="speedBlock"><div id="speedFill">&nbsp;</div></div></td>
                        <td class="menu right">Defence <input id="defenceControlID" class="checkbox" type="checkbox"> <input id="defenceForegroundControlID" class="menu input" type="text" maxlength="20" onchange="setColors()"><span id="defenceForegroundDisplayID" class="input">&nbsp;&nbsp;&nbsp;</span> on <span id="defenceBackgroundDisplayID" class="input">&nbsp;&nbsp;&nbsp;</span><input id="defenceBackgroundControlID" class="menu input" type="text" maxlength="20" onchange="setColors()"></td>
                        <td class="menu"><input id="fontWeightControlID" class="checkbox" type="checkbox" onclick="setFont()">bold <input id="fontStyleControlID" class="checkbox" type="checkbox" onclick="setFont()">italic</td>
                      </tr>
                    </table>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
        </table>
      </td>
    </tr>
    <tr>
      <td id="welcomeBlock" class="visible">
        <h1 id="welcomeTitle">SpellTrainer v0.61</h1>
        <p>[<a href="http://jolaf.jnm.ru/spelltrainer/">Latest version</a>] [<a href="http://code.google.com/p/spelltrainer/">Project page</a>] [<a href="mailto:vmzakhar@gmail.com?Subject=SpellTrainer">Contact mail</a>]</p>
        <p><img class="logo" src="wand.png" alt=""></p>
        <p>This software is created to train players in spellcasting for <a href="http://hp-ekb.ru">Hogwarts Seasons LARPs</a>.</p>
        <p>Adjust the settings at the top bar as neccessary and press</p>
        <p><button id="bigStartButton" type="button" onclick="start()">Start!</button></p>
        <p class="bold">Click anywhere in the spell window to stop and return to this screen.</p>
        <p>When you see a spell written in <span class="example attack">attack colors</span> &ndash; cast it at your imaginary opponent.</p>
        <p>When you see a spell written in <span class="example defence">defence colors</span> &ndash; it means that spell<br>is cast by your opponent at you, so cast the respective shield:</p>
        <table align="center" cellspacing="0" cellpadding="0">
          <tr>
            <td class="right">
                  Impedimenta, Tarantallegra, Silencio: <span class="bold">Protego</span>
              <br>Rictusempra, Incarcero, Mento Menores, Petrificus Totalus: <span class="bold">Defendo</span>
              <br>Stupefy, Achelitus, Maledicero: <span class="bold">Enervate</span>
              <br>Expelliarmus: <span class="bold">Para Bellum</span>
            </td>
            <td>&nbsp;&nbsp;&nbsp;</td>
            <td>
                  Incendio: <span class="bold">Deluvium</span>
              <br>Deluvium: <span class="bold">Incendio</span>
              <br>Tormencio: <span class="bold">Floridus</span>
              <br>Conjunctivitus: <span class="bold">Sensus Videndi</span>
            </td>
          </tr>
        </table>
        <p>Start with a comfortable tempo, and then increase the pace as your casting skill improves.</p>
        <p>If you experience problems or want to report a bug &ndash; please mail to <a href="mailto:vmzakhar@gmail.com?Subject=SpellTrainer">vmzakhar@gmail.com</a>.</p>
        <p class="bold">Good luck!</p>
        <p><br><a href="http://validator.w3.org/check?uri=referer" title="Valid HTML 4.01 Transitional"><img class="valid" src="validhtml401.png" alt="Valid HTML 4.01 Transitional"></a> <a href="http://jigsaw.w3.org/css-validator/check/referer" title="Valid CSS 2.1"><img class="valid" src="validcss.gif" alt="Valid CSS 2.1"></a></p>
      </td>
      <td id="castBlock" class="invisible" onclick="stop()"></td>
    </tr>
    <tr>
      <td id="footerBlock">
        <div id="loggerBlock"></div>
      </td>
    </tr>
  </table>
</body>
</html>

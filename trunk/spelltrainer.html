<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>SpellTrainer v0.3</title>
<meta http-equiv="Content-Type" content="Text/HTML; CharSet=ISO-8859-1">
<meta name="Author" content="Vasily Zakharov (vmzakhar@gmail.com)">
<link rel="Shortcut Icon" href="favicon.ico">
<style type="text/css">
html, body {
	margin: 0;
	padding: 0;
}

.wide {
	width: 100%;
}

.high {
	height: 100%;
}

.small {
	font-size: 80%;
}

body, p, td, th, div {
	font-family: Verdana, Arial, Helvetica, sans-serif;
}

a {
	font-weight: bold;
}

td#header, td#footer {
	background-color: gray;
	height: 38px;
}

img#logo {
	background-color: white;
}

a.title {
	text-decoration: none;
	font-weight: bold;
	color: black;
}

p.title {
	font-size: 80%;
	font-weight: bold;
	margin: 0;
	padding: 0;
}

td#cast {
	text-align: center;
	vertical-align: middle;
	font-weight: bold;
	color: black;
	background-color: white;
}

div#debug {
	height: 38px;
	font-size: 50%;
	overflow: auto;
}

td#banners {
	vertical-align: bottom;
}

img.valid {
	width: 88px;
	height: 31px;
	border: 0;
}
</style>

<script type="text/javascript">
function debug(message) {
    var debug = document.getElementById('debug');
    debug.innerHTML += new Date().toLocaleTimeString() + '&nbsp;&nbsp;' + message + '<br>';
    debug.scrollTop = debug.scrollHeight; // ToDo: this doesn't work well on IE
}

var SIMPLA = ['Impedimenta', 'Tarantallegra', 'Silencio',		// Protego
              'Rictusempra', 'Incarcero', 'Mento Menores',		// Defendo
              'Stupefy', 'Achelitus', 'Maledicero',			// Enervate
              'Incendio', 'Deluvium', 'Tormencio', 'Conjunctivitus'];	// VIP

var MAXIMA = [];
for (var i = 0, spell; spell = SIMPLA[i]; i++) {
     MAXIMA.push(spell + ' Maxima');
};
MAXIMA.concat(['Petrificus Totalus', 'Expelliarmus']);

var ULTIMA = [];
for (var i = 0, spell; spell = SIMPLA[i]; i++) {
     ULTIMA.push(spell + ' Ultima');
};

var RULE_OF_N_SPELLS = 3;

var FONT_NAME = 'Verdana';
var FONT_SIZE = 10;
var FONT_STYLE = 'bold';

var ATTACK_FOREGROUND  = 'green';
var ATTACK_BACKGROUND  = 'black';
var DEFENCE_FOREGROUND = 'white';
var DEFENCE_BACKGROUND = '#800000';
var FLASH_FOREGROUND = 'white';
var FLASH_BACKGROUND = 'white';

var spellDelay = 3000;
var flashDelay = 100;

var useSimpla = true;
var useMaxima = true;
var useUltima = true;

var trainAttack = true;
var trainDefence = true;

var aspect = 0;

var timeout;

function SpellGenerator(nSpells) {
    this.spells = [];
    this.nSpells = nSpells;
    this.previousSpells = [];
    this.next = function() {
        newSpell:
        while (true) {
            spell = this.spells[Math.floor(Math.random() * this.spells.length)];
            baseIndex = spell.indexOf(' ');
            baseSpell = baseIndex >= 0 ? spell.slice(0, baseIndex) : spell;
            for (var i = 0, previousSpell; previousSpell = this.previousSpells[i]; i++) {
                if (previousSpell === baseSpell) {
                    continue newSpell;
                }
            }
            this.previousSpells = (this.previousSpells.concat([baseSpell])).slice(-(this.nSpells - 1));
            return spell;
        }
    }
}

var attackSpells = new SpellGenerator(RULE_OF_N_SPELLS);
var defenceSpells = new SpellGenerator(RULE_OF_N_SPELLS);

function updateSpellList() {
    // Updates spell list and finds out the proper text aspect for resize().
    debug('updateSpellList');
    var spells = (useSimpla ? SIMPLA : []).concat(useMaxima ? MAXIMA : []).concat(useUltima ? ULTIMA : []);
    attackSpells.spells = defenceSpells.spells = spells;
    var cast = document.getElementById('cast');
    cast.innerHTML = '<table><tr><td id="test"><\/td><\/tr><\/table>';
    var test = document.getElementById('test');
    aspect = 0;
    for (var i = 0, spell; spell = spells[i]; i++) {
        test.innerHTML = spell;
        a = test.offsetWidth/test.offsetHeight;
        aspect = Math.max(aspect, a);
    }
    cast.innerHTML = null;
    aspect *= 1.5;
    resize();
}

function resize() {
    debug('resize');
    var cast = document.getElementById('cast');
    cast.style.fontSize = Math.floor(cast.offsetWidth/aspect) + 'px';
}

function nextSpell() {
    var cast = document.getElementById('cast');
    if (trainAttack && (!trainDefence || Math.random() >= 0.5)) {
        cast.innerHTML = attackSpells.next();
        cast.style.color = ATTACK_FOREGROUND;
        cast.style.backgroundColor = ATTACK_BACKGROUND;
        debug('Attack: ' + cast.innerHTML);
    } else {
        cast.innerHTML = defenceSpells.next();
        cast.style.color = DEFENCE_FOREGROUND;
        cast.style.backgroundColor = DEFENCE_BACKGROUND;
        debug('Defence: ' + cast.innerHTML);
    }
}

function hideSpell() {
    var cast = document.getElementById('cast');
    cast.style.color = FLASH_FOREGROUND;
    cast.style.backgroundColor = FLASH_BACKGROUND;
}

function cast() {
    nextSpell();
    timeout = setTimeout('hide()', spellDelay);
}

function hide() {
    hideSpell();
    timeout = setTimeout('cast()', flashDelay);
}

function start() {
    debug('start');
    var cast = document.getElementById('cast');
    cast.innerHTML = 'Get ready!';
    cast.style.color = 'white';
    cast.style.backgroundColor = 'black';
    timeout = setTimeout('cast()', spellDelay);
    button = document.getElementById('start');
    button.onclick = stop;
    button.innerHTML = 'Stop';
}

function stop() {
    debug('stop');
    clearTimeout(timeout);
    var cast = document.getElementById('cast');
    cast.innerHTML = document.getElementById('title').innerHTML;
    cast.style.color = 'black';
    cast.style.backgroundColor = 'white';
    button = document.getElementById('start');
    button.onclick = start;
    button.innerHTML = 'Start';
}

function main() {
    debug('main');
    updateSpellList();
    document.getElementById('title').innerHTML = document.getElementsByTagName('title')[0].innerHTML;
    document.getElementsByTagName('body')[0].onresize = onresize = resize;
    stop();
}
</script>
</head>

<body onload="main()">
  <noscript>This application requires JavaScript enabled.</noscript>
  <table class="wide high" cellspacing="0" cellpadding="0">
    <tr>
      <td id="header">
        <table cellspacing="0" cellpadding="0">
          <tr>
            <td><a class="title" href="http://code.google.com/p/spelltrainer/"><img id="logo" src="wand.png" alt=""></a></td>
            <td><a id="title" class="title" href="http://code.google.com/p/spelltrainer/"></a></td>
            <td><button id="start" type="button"></button></td>
          </tr>
        </table>
      </td>
    </tr>
    <tr class="high">
      <td id="cast"></td>
    </tr>
    <tr>
      <td id="footer">
        <table class="wide high" cellspacing="0" cellpadding="0">
          <tr>
            <td class="wide"><div id="debug"></div></td>
            <td id="banners"><a href="http://validator.w3.org/check?uri=referer" title="Valid HTML 4.01 Transitional"><img class="valid" src="http://www.w3.org/Icons/valid-html401-blue.png" alt="Valid HTML 4.01 Transitional"></a>&nbsp;<a href="http://jigsaw.w3.org/css-validator/check/referer" title="Valid CSS 2.1"><img class="valid" src="http://jigsaw.w3.org/css-validator/images/vcss-blue" alt="Valid CSS 2.1"></a></td>
          </tr>
        </table>
      </td>
    </tr>
  </table>
</body>
</html>
